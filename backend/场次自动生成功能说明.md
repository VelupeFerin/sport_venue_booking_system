# 场次自动生成功能说明

## 功能概述

本系统实现了根据场次模板自动生成次日场次的功能，包括：

1. **每日0点自动生成**：系统会在每日0点自动根据场次模板生成次日的场次
2. **启动时初始化**：程序启动时会检查场次表是否为空，如果为空则自动执行场次生成流程
3. **清除过期场次**：自动清除已过期的场次记录
4. **重试机制**：场次生成失败时最多重试3次
5. **完整模板覆盖**：生成所有场次模板对应的场次，包括不开放的场次（以保留备注信息）

## 核心组件

### 1. Session实体类
- 位置：`com.sport_venue_booking_system.entity.Session`
- 对应数据库中的`session`表
- 包含场次的基本信息：场地名称、开始时间、价格、状态等

### 2. SessionRepository
- 位置：`com.sport_venue_booking_system.repository.SessionRepository`
- 提供场次相关的数据库操作方法
- 包含删除过期场次、查询指定日期范围场次等方法

### 3. SessionService
- 接口：`com.sport_venue_booking_system.service.SessionService`
- 实现：`com.sport_venue_booking_system.service.impl.SessionServiceImpl`
- 提供场次业务逻辑处理，包括：
  - 根据模板生成次日场次（包括不开放的场次）
  - 清除过期场次
  - 场次状态管理

### 4. SessionSchedulerService
- 位置：`com.sport_venue_booking_system.service.SessionSchedulerService`
- 定时任务服务，负责每日0点自动执行场次生成
- 包含重试机制，最多重试3次

### 5. SessionController
- 位置：`com.sport_venue_booking_system.controller.SessionController`
- 提供场次相关的REST API接口
- 支持手动触发场次生成和清除过期场次

## 功能特性

### 1. 自动生成机制
- **触发时间**：每日0点自动执行
- **生成逻辑**：根据所有场次模板生成次日场次（包括激活和不激活的模板）
- **去重处理**：避免重复生成已存在的场次
- **批量保存**：使用批量保存提高性能
- **备注保留**：保留模板中的备注信息，包括不开放场次的原因说明

### 2. 重试机制
- **最大重试次数**：3次
- **重试间隔**：5秒
- **异常处理**：捕获并记录异常信息
- **成功判断**：根据生成结果判断是否成功

### 3. 启动时初始化
- **检查条件**：检查场次表是否为空
- **初始化流程**：清除过期场次 → 生成次日场次
- **日志记录**：记录初始化过程和结果

### 4. 过期场次清理
- **清理时机**：每日0点定时清理 + 启动时清理
- **清理条件**：场次开始时间 < 当前时间
- **事务处理**：使用事务确保数据一致性

### 5. 完整模板覆盖
- **生成范围**：所有场次模板（激活和不激活）
- **状态保持**：生成的场次保持模板的激活状态
- **备注传递**：完整传递模板中的备注信息
- **用途说明**：不开放的场次可用于说明维护、故障等原因

## API接口

### 1. 获取场次列表
```
GET /api/sessions
```

### 2. 获取可预订场次
```
GET /api/sessions/available
```

### 3. 手动生成次日场次（管理员）
```
POST /api/sessions/generate-next-day
```
**说明**：根据所有场次模板生成次日场次，包括不开放的场次（以保留备注信息）

### 4. 清除过期场次（管理员）
```
DELETE /api/sessions/clear-expired
```

### 5. 标记场次为已预订
```
PUT /api/sessions/{id}/book
```

### 6. 标记场次为未预订
```
PUT /api/sessions/{id}/unbook
```

## 配置说明

### 1. 定时任务配置
在主应用类中启用定时任务：
```java
@SpringBootApplication
@EnableScheduling
public class SportVenueBookingSystemApplication {
    // ...
}
```

### 2. 定时表达式
```java
@Scheduled(cron = "0 0 0 * * ?") // 每天0点执行
```

### 3. 重试配置
```java
private static final int MAX_RETRY_ATTEMPTS = 3; // 最大重试次数
```

## 数据库表结构

### session表
```sql
CREATE TABLE session (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    court_name VARCHAR(10) NOT NULL,
    start_time DATETIME NOT NULL,
    price DECIMAL(8, 2) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_booked BOOLEAN NOT NULL DEFAULT FALSE,
    note TEXT,
    PRIMARY KEY (id),
    KEY idx_court_booked_time (court_name, is_booked, start_time),
    UNIQUE KEY uniq_court_time (court_name, start_time)
);
```

## 使用场景

### 1. 正常营业场次
- 模板状态：`is_active = true`
- 生成场次：`is_active = true`
- 用户可预订

### 2. 维护/故障场次
- 模板状态：`is_active = false`
- 备注信息：`"场地维护中"`、`"设备故障"`等
- 生成场次：`is_active = false`
- 用户不可预订，但可查看备注了解原因

### 3. 特殊说明场次
- 模板状态：`is_active = false`
- 备注信息：`"暂停预订"`、`"特殊活动"`等
- 生成场次：`is_active = false`
- 保留说明信息供用户查看

## 测试

### 单元测试
- 位置：`service.com.sport_venue_booking_system.SessionServiceTest`
- 测试内容：
  - 场次生成成功场景（包含激活和不激活模板）
  - 无模板场景
  - 场次已存在场景
  - 只包含不激活模板的场景
  - 表空检查

### 手动测试
1. 启动应用，观察日志中的初始化信息
2. 调用API手动生成场次
3. 检查数据库中生成的场次记录（包括不激活的场次）
4. 验证备注信息是否正确传递

## 注意事项

1. **时区设置**：确保应用时区设置正确，避免时间计算错误
2. **数据库连接**：确保数据库连接稳定，避免定时任务执行失败
3. **日志监控**：定期检查日志，确保场次生成任务正常执行
4. **性能考虑**：大量场次生成时注意数据库性能
5. **数据一致性**：使用事务确保数据操作的原子性
6. **备注信息**：不开放场次的备注信息对用户可见，注意内容的准确性

## 故障排查

### 1. 场次生成失败
- 检查场次模板是否存在
- 检查数据库连接是否正常
- 查看应用日志中的错误信息

### 2. 定时任务不执行
- 检查`@EnableScheduling`注解是否正确配置
- 检查定时表达式是否正确
- 检查应用是否正常运行

### 3. 数据不一致
- 检查事务配置是否正确
- 检查并发访问是否导致数据冲突
- 检查唯一约束是否被违反

### 4. 备注信息丢失
- 检查模板中的备注信息是否正确
- 检查场次生成时是否正确传递备注
- 检查前端是否正确显示备注信息 